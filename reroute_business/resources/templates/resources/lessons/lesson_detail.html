{% extends "base.html" %}
{% load static %}

{% block title %}ReRoute | {{ lesson.title }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'resources/css/lesson.css' %}">

<section class="lesson-container">
  <header class="lesson-header">
    <h1 class="lesson-title">{{ lesson.title }}</h1>
    <p class="lesson-desc">{{ lesson.description }}</p>
  </header>

  <div class="lesson-player-wrap">
    {% if lesson.youtube_video_id %}
      <div id="ytPlayerWrapper" class="lesson-video" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:8px;background:#000;">
        <div id="ytPlayer" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
      </div>
    {% else %}
      <video id="lessonVideo" class="lesson-video" playsinline controls preload="metadata">
        <source src="{{ lesson.video_static_path }}" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    {% endif %}

    <!-- New post-video quiz flow -->
    <div id="lessonQuizActions" class="lesson-quiz-actions" hidden>
      <button id="lessonStartQuiz" type="button" class="lesson-btn primary">Take the Quiz</button>
    </div>
    <div id="lessonQuizContainer" class="lesson-quiz-container" hidden aria-live="polite"></div>
  </div>
</section>

<script>
  window.__LESSON_SLUG__ = "{{ lesson.slug }}";
  window.__CSRF_TOKEN__ = "{{ csrf_token }}";
  window.__LESSON_YT_ID__ = "{{ lesson.youtube_video_id|default_if_none:'' }}" || null;
  // Ensure a session key exists for guests
  (function(){ if(!sessionStorage.getItem('resources:session:init')) { sessionStorage.setItem('resources:session:init', '1'); } })();
  // Base endpoints
  window.__LESSON_ENDPOINTS__ = {
    schema: "{% url 'lesson_schema' lesson.slug %}",
    attempt: "{% url 'lesson_attempt' lesson.slug %}",
    // progress removed in simplified flow
  };
</script>
<script src="{% static 'resources/js/lesson_controller.js' %}" defer></script>
{% endblock %}
