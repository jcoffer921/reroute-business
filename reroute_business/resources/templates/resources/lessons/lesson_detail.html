{% extends "base.html" %}
{% load static %}

{% block title %}ReRoute | {{ lesson.title }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'resources/css/lesson.css' %}">
<style>
  .lesson-layout { display: grid; grid-template-columns: 1fr; gap: 24px; }
  /* Two-column: left (quiz 30%), right (video 70%) */
  @media (min-width: 768px){ .lesson-layout { grid-template-columns: 3fr 7fr; align-items: start; } }
  .lesson-side { position: static; }
  @media (min-width: 768px){ .lesson-side { position: sticky; top: 88px; } }
  .quiz-panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
  .quiz-panel h2 { font-size: 1.25rem; margin: 0 0 .5rem; }
  .lesson-quiz-container[hidden] { display: none !important; }
  .lesson-quiz-question { margin-top: 12px; }
  .lesson-quiz-choices label { display:flex; gap:8px; padding:6px 0; }
  .lesson-btn.primary { background:#1b3b82; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .lesson-quiz-actions-bar { display:flex; justify-content:flex-end; margin-top: 8px; }
  .lesson-quiz-result { color:#1b3b82; font-weight:600; margin-top:8px; }
  .yt-embed-fit { width: 100%; height: 0; padding-bottom: 56.25%; position: relative; max-height: 65vh; }
  .yt-embed-fit iframe, .yt-embed-fit embed { position: absolute; inset: 0; width: 100%; height: 100%; }
  .lesson-video { width: 100%; max-height: 65vh; background: #000; }
  .rr-mb-12 { margin-bottom: 12px; }
  .rr-w-100 { width: 100%; }
  .rr-flex-row-8 { display:flex; gap:8px; align-items:center; }
  .lesson-header { margin-bottom: 8px; }
  .lesson-title { margin: 12px 0 6px; font-size:1.6rem; font-weight:800; color:#1b3b82; }
  .lesson-desc { color:#6b7280; }
  .muted-note { color:#6b7280; font-size:.9rem; }
</style>

<section class="lesson-layout">
  <aside class="lesson-side">
    <div class="quiz-panel">
      <h2>Quiz</h2>
      <div id="lessonQuizContainer" class="lesson-quiz-container" aria-live="polite"></div>
      <div class="lesson-quiz-actions-bar">
        <button id="lessonQuizSubmit" type="button" class="lesson-btn primary">Submit</button>
      </div>
      <div id="lessonQuizResult" class="lesson-quiz-result"></div>
    </div>
  </aside>

  <div>
    <header class="lesson-header">
      <h1 class="lesson-title">{{ lesson.title }}</h1>
      <p class="lesson-desc">{{ lesson.description }}</p>
    </header>

    {% if lesson.youtube_video_id %}
      <div id="ytPlayerWrapper" class="yt-wrapper rr-mb-12">
        <div id="ytPlayer" class="yt-embed-fit"></div>
      </div>
    {% else %}
      <video id="lessonVideo" class="lesson-video rr-mb-12" playsinline controls preload="metadata">
        <source src="{{ lesson.video_static_path }}" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    {% endif %}

    <p class="muted-note">Watch the video and answer the questions on the right. Submit anytime.</p>
  </div>
</section>

<script>
  window.__LESSON_SLUG__ = "{{ lesson.slug }}";
  window.__CSRF_TOKEN__ = "{{ csrf_token }}";
  window.__LESSON_YT_ID__ = "{{ lesson.youtube_video_id|default_if_none:'' }}" || null;
  // Ensure a session key exists for guests
  (function(){ if(!sessionStorage.getItem('resources:session:init')) { sessionStorage.setItem('resources:session:init', '1'); } })();
  // Base endpoints
  window.__LESSON_ENDPOINTS__ = {
    schema: "{% url 'lesson_schema' lesson.slug %}",
    attempt: "{% url 'lesson_attempt' lesson.slug %}",
  };
</script>
<script src="{% static 'resources/js/lesson_controller.js' %}" defer></script>
{% endblock %}
