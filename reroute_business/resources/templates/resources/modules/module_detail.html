{% extends "base.html" %}
{% load static resources_extras %}

{% block title %}ReRoute | {{ module.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'resources/css/module_detail.css' %}">
{% endblock %}

{% block content %}
<div class="module-shell">
  <section class="module-hero-card">
    <div class="module-hero-card__eyebrow">{{ module.get_category_display|default:"Learning Module" }}</div>
    <h1 class="module-hero-card__title">{{ module.title }}</h1>
    <p class="module-hero-card__subtitle">Build a confident resume in minutes with expert guidance.</p>
    <div class="module-hero-card__meta">
      <span>{{ module.get_category_display|default:"Workforce Readiness" }}</span>
      <span>{{ question_count|default:0 }} question{% if question_count|default:0 != 1 %}s{% endif %}</span>
      <span>On-demand video</span>
      <span>Beginner friendly</span>
    </div>
  </section>

  <div class="module-grid">
    <aside class="module-sidebar">
      <div class="module-card module-card--sidebar">
        <div class="sidebar-heading">
          <p class="sidebar-pill">Knowledge Check</p>
          <h2>Keep your progress on track</h2>
          <p class="sidebar-text">
            {% if user_score %}
              Last score: {{ user_score.score }} / {{ user_score.total_questions }} on {{ user_score.updated_at|date:"M j, Y" }}.
            {% elif not can_submit_quiz %}
              Log in to take the quiz and save your results.
            {% elif question_count %}
              {{ question_count }} question{% if question_count|default:0 != 1 %}s{% endif %} to reinforce your learning.
            {% else %}
              Quiz questions are being prepared for this module.
            {% endif %}
          </p>
        </div>

        <dl class="sidebar-stats">
          <div>
            <dt>Quiz length</dt>
            <dd>{{ question_count|default:0 }} question{% if question_count|default:0 != 1 %}s{% endif %}</dd>
          </div>
          <div>
            <dt>Your progress</dt>
            <dd id="sidebarProgressValue">{{ progress_percent }}%</dd>
          </div>
        </dl>

        <div class="module-progress" aria-label="Quiz completion {{ progress_percent }} percent">
          <div class="module-progress__track">
            <span id="sidebarProgressFill" class="module-progress__fill" style="--progress-value: {{ progress_percent }}%;"></span>
          </div>
          <p class="module-progress__meta" id="sidebarProgressMeta">
            {% if user_score %}
              {{ user_score.score }} of {{ user_score.total_questions }} answered correctly
            {% else %}
              Start the quiz to begin tracking
            {% endif %}
          </p>
        </div>

        <button id="quizStartBtn" class="module-btn module-btn--primary" type="button">
          {% if user_score %}Continue Quiz{% else %}Start Quiz{% endif %}
        </button>
      </div>
    </aside>

    <main class="module-main">
      <article class="module-card module-card--video">
        <div class="module-video-wrap">
          {% if yt_id %}
            <iframe src="https://www.youtube-nocookie.com/embed/{{ yt_id }}?rel=0&modestbranding=1&playsinline=1"
                    title="Module video" referrerpolicy="strict-origin-when-cross-origin"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          {% elif module.video_url and module.video_url|endswith:'.mp4' %}
            <video controls playsinline preload="metadata">
              <source src="{{ module.video_url }}" type="video/mp4">
            </video>
          {% elif module.embed_html %}
            {{ module.embed_html|safe }}
          {% else %}
            <div class="module-video-placeholder">
              Video coming soon for this module.
            </div>
          {% endif %}
        </div>
        <div class="module-meta-row">
          <div>
            <p class="module-meta-heading">About this module</p>
            <p class="module-meta-body">
              {% if module.description %}
                {{ module.description }}
              {% else %}
                Watch the lesson, then take the quiz to make sure the essentials stick.
              {% endif %}
            </p>
          </div>
        </div>
      </article>

      <section class="module-card module-card--takeaways">
        <div class="takeaways-header">
          <p class="takeaways-pill">Key Takeaways</p>
          <h3>What you’ll remember</h3>
        </div>
        <div class="takeaways-body">
          {% with takeaways=module.key_takeaways_list %}
            {% if takeaways %}
              <ul>
                {% for note in takeaways %}
                  <li>{{ note }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <ul>
                <li>Watch the video and follow along.</li>
                <li>Use the quiz to reinforce your learning.</li>
                <li>Revisit sections that need more practice.</li>
              </ul>
            {% endif %}
          {% endwith %}
        </div>
      </section>

      {% if module.internal_content %}
        <section class="module-card module-card--notes">
          <h3>Notes &amp; Additional Content</h3>
          <div class="module-notes">
            {{ module.internal_content|safe }}
          </div>
        </section>
      {% endif %}

      <section id="quizSection" class="module-card module-card--quiz">
        <header class="quiz-header">
          <div>
            <p class="quiz-pill">Guided Quiz</p>
            <h2>Test yourself with bite-sized questions</h2>
            <p>Work through one question at a time, then submit to see how you did.</p>
          </div>
        </header>

        <div
          id="quizFlow"
          class="quiz-flow"
          data-quiz-url="{% url 'module_quiz_schema' module.id %}"
          data-submit-url="{% url 'module_quiz_submit' module.id %}"
          data-can-submit="{{ can_submit_quiz|yesno:'true,false' }}"
          data-module-id="{{ module.id }}"
        >
          <div class="quiz-flow__status">
            <div class="quiz-progress-label" id="quizProgressLabel">Loading quiz…</div>
            <div class="module-progress module-progress--inline">
              <div class="module-progress__track">
                <span class="module-progress__fill" id="quizProgressFill"></span>
              </div>
            </div>
          </div>

          <div id="quizQuestionStage" class="quiz-question-card" role="group" aria-live="polite"></div>

          <div class="quiz-nav">
            <button id="quizPrevBtn" type="button" class="module-btn module-btn--ghost" disabled>Previous</button>
            <button id="quizNextBtn" type="button" class="module-btn module-btn--ghost" disabled>Next</button>
          </div>

          <div class="quiz-cta">
            <button
              id="quizSubmitBtn"
              class="module-btn module-btn--primary"
              type="button"
              data-login-required="{{ can_submit_quiz|yesno:'false,true' }}"
            >
              Submit Quiz{% if not can_submit_quiz %} (Preview Only){% endif %}
            </button>
            <button id="quizCompleteBtn" type="button" class="module-btn module-btn--ghost">Mark Module Complete</button>
          </div>

          <div id="quizResultCard" class="quiz-result-card" role="status" aria-live="polite"></div>
        </div>
      </section>
    </main>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'resources/js/module_quiz_csp.js' %}" defer></script>
{% endblock %}
