{% extends "base.html" %}
{% load static resources_extras %}

{% block title %}ReRoute | {{ module.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'resources/css/module_detail.css' %}">
{% endblock %}

{% block content %}
<div class="module-shell">
  <header class="module-hero">
    <p class="module-kicker">{{ module.get_category_display }}</p>
    <h1 class="module-title">{{ module.title }}</h1>
    <p class="module-meta">
      {% if question_count %}
        {{ question_count }} quiz question{% if question_count|default:0 != 1 %}s{% endif %} â€¢
      {% endif %}
      Learn, watch, and check your progress all in one place.
    </p>
  </header>

  <div class="module-grid">
    <aside class="module-sidebar">
      <div class="quiz-card">
        <div class="quiz-title">Knowledge Check</div>
        <div class="quiz-status">
          {% if user_score %}
            <div class="quiz-status__label">Last Score</div>
            <div class="quiz-status__value">{{ user_score.score }} / {{ user_score.total_questions }}</div>
            <div class="quiz-status__meta">Updated {{ user_score.updated_at|date:"M j, Y g:i a" }}</div>
          {% elif not can_submit_quiz %}
            <div class="quiz-status__meta">Log in to take this quiz and save your score.</div>
          {% elif question_count %}
            <div class="quiz-status__meta">
              {{ question_count }} question{% if question_count|default:0 != 1 %}s{% endif %}. Submit to track your progress.
            </div>
          {% else %}
            <div class="quiz-status__meta">Quiz questions are being prepared for this module.</div>
          {% endif %}
        </div>

        <div
          id="quizPanel"
          data-quiz-url="{% url 'module_quiz_schema' module.id %}"
          data-submit-url="{% url 'module_quiz_submit' module.id %}"
          data-can-submit="{{ can_submit_quiz|yesno:'true,false' }}"
        ></div>

        <div class="quiz-actions">
          <button
            id="quizSubmit"
            class="quiz-submit"
            data-submit-url="{% url 'module_quiz_submit' module.id %}"
            data-can-submit="{{ can_submit_quiz|yesno:'true,false' }}"
            {% if not can_submit_quiz %}disabled aria-disabled="true"{% endif %}
          >
            {% if can_submit_quiz %}Submit Quiz{% else %}Log In to Submit{% endif %}
          </button>
        </div>
        <div id="quizResult" class="quiz-result" role="status" aria-live="polite"></div>
      </div>
    </aside>

    <main class="module-content">
      <div class="module-media">
        {% if yt_id %}
          <iframe src="https://www.youtube-nocookie.com/embed/{{ yt_id }}?rel=0&modestbranding=1&playsinline=1"
                  title="Module video" referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        {% elif module.video_url and module.video_url|endswith:'.mp4' %}
          <video controls playsinline preload="metadata">
            <source src="{{ module.video_url }}" type="video/mp4">
          </video>
        {% elif module.embed_html %}
          {{ module.embed_html|safe }}
        {% else %}
          <div class="module-media__placeholder">
            Video coming soon for this module.
          </div>
        {% endif %}
      </div>

      <section class="module-section">
        <h3>About this module</h3>
        {% if module.description %}
          <p class="module-desc">{{ module.description }}</p>
        {% else %}
          <p class="module-desc">Watch the lesson, then take the quiz to check what stuck.</p>
        {% endif %}
      </section>

      <section class="module-section">
        <h3>Key Takeaways</h3>
        <div class="module-notes">
          {% with takeaways=module.key_takeaways_list %}
            {% if takeaways %}
              <ul>
                {% for note in takeaways %}
                  <li>{{ note }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <ul>
                <li>Watch the video and follow along.</li>
                <li>Use the quiz to reinforce your learning.</li>
                <li>Revisit sections that need more practice.</li>
              </ul>
            {% endif %}
          {% endwith %}
        </div>
      </section>

      {% if module.internal_content %}
        <section class="module-section">
          <h3>Notes &amp; Additional Content</h3>
          <div class="module-notes">
            {{ module.internal_content|safe }}
          </div>
        </section>
      {% endif %}
    </main>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'resources/js/module_quiz_csp.js' %}" defer></script>
{% endblock %}
