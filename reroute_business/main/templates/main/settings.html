{% extends "base.html" %}
{% load static %}

{% block title %}ReRoute | Account Settings{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/settings.css' %}">

<section class="settings-hero">
  <div class="settings-hero-content">
    <h1>Account Settings</h1>
    <p>Manage your account settings and preferences.</p>
  </div>
</section>

<div class="settings-grid">
  <!-- Left: Category cards -->
  <nav class="settings-nav" aria-label="Settings Categories">
    <h3 class="nav-group-label">Account</h3>
    <button class="nav-card active" data-panel="account">
      <span class="nav-icon" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="8" r="3.5" stroke="#006da0" stroke-width="1.6"/>
          <path d="M5 20a7 7 0 0 1 14 0" stroke="#00beb8" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </span>
      <span class="nav-title">Account Preferences</span>
      <span class="nav-sub">Profile, email, general</span>
    </button>

    <button class="nav-card" data-panel="security">
      <span class="nav-icon" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3l8 4v5c0 5-3.5 9-8 9s-8-4-8-9V7l8-4z" stroke="#006da0" stroke-width="1.6"/>
          <path d="M9 13l2 2 4-4" stroke="#00beb8" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </span>
      <span class="nav-title">Sign In &amp; Security</span>
      <span class="nav-sub">Password, 2FA, recovery</span>
    </button>

    <h3 class="nav-group-label">Preferences</h3>
    <button class="nav-card" data-panel="billing">
      <span class="nav-icon" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="6" width="18" height="12" rx="2" stroke="#006da0" stroke-width="1.6"/>
          <path d="M3 10h18" stroke="#00beb8" stroke-width="1.6"/>
        </svg>
      </span>
      <span class="nav-title">Billing</span>
      <span class="nav-sub">Subscription &amp; plans</span>
    </button>

    <button class="nav-card" data-panel="notifications">
      <span class="nav-icon" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9a6 6 0 0 1 12 0v4l1.5 2H4.5L6 13V9z" stroke="#006da0" stroke-width="1.6"/>
          <path d="M10 18a2 2 0 0 0 4 0" stroke="#00beb8" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </span>
      <span class="nav-title">Notifications</span>
      <span class="nav-sub">Emails, job updates, reminders</span>
    </button>
  </nav>


  <!-- Right: Panels -->
  <div class="settings-panels">
    <!-- Account Panel -->
    <section class="panel active" id="panel-account" aria-labelledby="tab-account">
      {# Subscription moved to Billing panel #}

      <!-- Account Preferences: Username, Display Name, Employment Status -->
      <div class="settings-section">
        <h2 id="heading-account-prefs">Account Preferences</h2>
        <p class="help-text" style="margin-top:-4px; color:#6b7280;">Choose how your name appears and update your availability.</p>
        <form method="POST" aria-labelledby="heading-account-prefs">
          {% csrf_token %}
          <div class="form-row-2">
            <div class="form-group">
              <label for="id_username">Username <span class="hint">(system ID)</span></label>
              {{ account_prefs_form.username }}
              <p class="input-help">Used for login; cannot be changed frequently.</p>
            </div>
            <div class="form-group">
              <label for="id_display_name">Display Name</label>
              {{ account_prefs_form.display_name }}
              <p class="input-help">Public-facing name shown to employers and users.</p>
            </div>
          </div>
          <div class="form-group">
            <label for="id_status">Employment Status</label>
            {{ account_prefs_form.status }}
          </div>
          <button type="submit" name="update_account_prefs" class="btn-primary btn-pill">Save Preferences</button>
        </form>
      </div>

      <!-- Change Email -->
      <div class="settings-section">
        <h2 id="heading-change-email">Change Email</h2>
        <form method="POST" aria-labelledby="heading-change-email">
          {% csrf_token %}
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" name="email" id="email" class="input-small" value="{{ request.user.email }}" placeholder="Email Address" autocomplete="email" required>
          </div>
          <button type="submit" name="update_email" class="btn-primary btn-pill">Change Email</button>
        </form>
      </div>

      <!-- Account Management -->
      <div class="settings-box danger-zone">
        <h3 id="heading-account-mgmt">Account Management</h3>
        <form method="POST" aria-labelledby="heading-account-mgmt">
          {% csrf_token %}
          <div class="button-row">
            <button type="submit" name="deactivate_account" class="btn btn-secondary btn-pill">Deactivate Account</button>
            <button type="submit" name="delete_account" class="btn btn-danger btn-pill" onclick="return confirm('Are you sure? This will permanently delete your account.')">Delete Account</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Security Panel -->
    <section class="panel" id="panel-security" aria-labelledby="tab-security">
      <div class="settings-section">
        <h2 id="heading-change-password">Change Password</h2>
        <form method="POST" aria-labelledby="heading-change-password">
          {% csrf_token %}
          <div class="form-group">
            <label for="id_old_password">Current Password</label>
            {{ password_form.old_password }}
          </div>
          <div class="form-group">
            <label for="id_new_password1">New Password</label>
            {{ password_form.new_password1 }}
          </div>
          <div class="form-group">
            <label for="id_new_password2">Confirm Password</label>
            {{ password_form.new_password2 }}
          </div>
          <button type="submit" name="change_password" class="btn-primary btn-pill">Change Password</button>
        </form>
      </div>

      <div class="settings-section">
        <h2>Two-Factor Authentication</h2>
        <form>
          <div class="form-group" style="flex-direction:row; align-items:center; justify-content:space-between;">
            <label for="twofa">Enable 2FA (Coming Soon)</label>
            <input id="twofa" type="checkbox" disabled>
          </div>
          <button type="button" class="btn btn-secondary btn-pill" disabled>Configure 2FA</button>
        </form>
      </div>

      <!-- Recovery Options -->
      <div class="settings-section">
        <h2 id="heading-recovery">Recovery Options</h2>
        <p class="help-text" style="margin-top:-4px; color:#6b7280;">Add a backup email or phone number so you can recover access if you lose your password or device.</p>
        <form id="recoveryForm" method="POST" aria-labelledby="heading-recovery">
          {% csrf_token %}
          <div class="form-row-2">
            <div class="form-group">
              <label for="id_backup_email">Backup Email</label>
              {{ recovery_form.backup_email }}
            </div>
            <div class="form-group">
              <label for="id_backup_phone">Backup Phone</label>
              {{ recovery_form.backup_phone }}
            </div>
          </div>
          <button type="submit" name="update_recovery" class="btn-primary btn-pill">Save Recovery Options</button>
        </form>
      </div>
    </section>

    <!-- Notifications Panel -->
    <section class="panel" id="panel-notifications" aria-labelledby="tab-notifications">
      <div class="settings-section">
        <h2>Email Notifications</h2>
        <form class="notify-form">
          <div class="notify-row">
            <div class="notify-text">
              <label for="alerts-jobs" class="notify-label">Job updates</label>
              <p class="notify-help">Get notified when new jobs match your preferences.</p>
            </div>
            <label class="toggle">
              <input id="alerts-jobs" type="checkbox" checked>
              <span class="slider"></span>
            </label>
          </div>

          <div class="notify-row">
            <div class="notify-text">
              <label for="alerts-reminders" class="notify-label">Reminders</label>
              <p class="notify-help">Receive reminders for saved jobs and upcoming deadlines.</p>
            </div>
            <label class="toggle">
              <input id="alerts-reminders" type="checkbox" checked>
              <span class="slider"></span>
            </label>
          </div>

          <div class="notify-row">
            <div class="notify-text">
              <label for="alerts-news" class="notify-label">News &amp; tips</label>
              <p class="notify-help">Occasional product updates and career tips.</p>
            </div>
            <label class="toggle">
              <input id="alerts-news" type="checkbox">
              <span class="slider"></span>
            </label>
          </div>

          <div class="notify-actions">
            <button type="button" class="btn btn-secondary btn-pill btn-sm" disabled>Save Preferences</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Billing Panel -->
    <section class="panel" id="panel-billing" aria-labelledby="tab-billing">
      <div class="settings-section settings-section--flat">
        <div class="settings-card" role="region" aria-labelledby="heading-subscription">
          <div class="settings-card__head">
            <h3 id="heading-subscription" class="settings-card__title">Subscription</h3>
          </div>
          <div class="kv">
            <div class="kv__row">
              <div class="kv__label">Current Plan</div>
              <div class="kv__value plan-name">
                {{ subscription.plan_name }}
                {% if is_employer and subscription.plan_name|lower in 'basic pro enterprise' %}
                  <span class="pill pill--ok" style="margin-left:8px;">Current</span>
                {% endif %}
              </div>
            </div>
            <div class="kv__row">
              <div class="kv__label">Status</div>
              <div class="kv__value">
                <span class="pill {% if subscription.active %}pill--ok{% else %}pill--warn{% endif %}">
                  {% if subscription.active %}Active{% else %}Inactive{% endif %}
                </span>
              </div>
            </div>
            {% if is_employer and subscription.expiry_date %}
            <div class="kv__row">
              <div class="kv__label">Next Billing Date</div>
              <div class="kv__value">{{ subscription.expiry_date|date:"F j, Y" }}</div>
            </div>
            {% endif %}
          </div>
          <div class="settings-card__actions settings-card__actions--footer">
            <a href="{{ subscription_pricing_url }}" class="btn btn-primary btn-pill" {% if is_employer and not is_verified %}aria-disabled="true" data-disabled="true"{% endif %}>
              {% if is_employer %}
                {% if is_employer and subscription.plan_name|lower in 'basic pro enterprise' %}
                  Manage Plan
                {% else %}
                  Choose a Plan
                {% endif %}
              {% else %}
                View Plans
              {% endif %}
            </a>
            {% if is_employer %}
            <form method="post" action="{% url 'profiles:cancel_subscription' %}" onsubmit="return confirm('Cancel your subscription and revert to Free?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-pill">Cancel Subscription</button>
            </form>
            {% endif %}
          </div>
        </div>
        {% if is_employer and not is_verified %}
          <p class="help-text" style="margin-top: 0.75rem; color:#b45309;">Your account must be verified before upgrading your plan.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>

<!-- Support CTA under everything -->
<div class="support-card">
  <p class="support-text">Can't find what you're looking for?</p>
  <a href="{% url 'contact' %}" class="btn btn-outline btn-pill btn-sm">Ask Support</a>
</div>

<script>
  (function(){
    const navCards = document.querySelectorAll('.nav-card');
    const panels = document.querySelectorAll('.panel');
    navCards.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-panel');
        // active state
        navCards.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        panels.forEach(p=>p.classList.remove('active'));
        const panel = document.getElementById('panel-' + id);
        if (panel) panel.classList.add('active');
      });
    });
  })();

  // AJAX submit + phone mask for Recovery Options
  (function(){
    const form = document.getElementById('recoveryForm');
    if (!form) return;

    // Simple phone formatter: (123) 456-7890
    const phoneInput = form.querySelector('#id_backup_phone');
    if (phoneInput) {
      phoneInput.addEventListener('input', () => {
        const digits = phoneInput.value.replace(/\D/g, '').slice(0, 10);
        const parts = [];
        if (digits.length > 0) parts.push('(' + digits.slice(0, Math.min(3, digits.length)) + (digits.length >= 3 ? ')' : ''));
        if (digits.length > 3) parts.push(' ' + digits.slice(3, Math.min(6, digits.length)));
        if (digits.length > 6) parts.push('-' + digits.slice(6));
        phoneInput.value = parts.join('');
      });
    }

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'toast toast-success';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 10);
      setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); }, 2200);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new URLSearchParams(new FormData(form));
      // Ensure the correct POST action is sent
      if (!data.get('update_recovery')) data.append('update_recovery', '1');
      const res = await fetch(window.location.href, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: data.toString(),
      }).catch(() => null);
      if (res && res.ok) {
        showToast('Recovery options saved');
      }
    });
  })();
</script>
{% endblock %}
