{% extends "base.html" %}
{% load static %}
{% load socialaccount %}

{% block title %}ReRoute | Sign Up{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/signup.css' %}">

{% url 'socialaccount_login' 'google' as google_base %}
{% url 'oauth_role_redirect' as oauth_role_redirect_url %}
{% with google_next=oauth_role_redirect_url|add:'?role=user' google_login_url=google_base|add:'?next='|add:google_next %}

<div class="auth-shell">
  <div class="auth-grid">
    <div class="auth-panel">
      <div class="auth-panel-card signup-card">
        <div
          id="signup-react-root"
          data-action="{% url 'signup' %}"
          data-next="{{ request.GET.next|default:'/dashboard/' }}"
          data-first-name="{{ user_form.first_name.value|default:'' }}"
          data-last-name="{{ user_form.last_name.value|default:'' }}"
          data-username="{{ user_form.username.value|default:'' }}"
          data-email="{{ user_form.email.value|default:'' }}"
          data-errors="{% if user_form.errors %}{% for field in user_form %}{% for error in field.errors %}{{ error }} {% endfor %}{% endfor %}{% for error in user_form.non_field_errors %}{{ error }} {% endfor %}{% endif %}"
          data-sitekey="{{ recaptcha_site_key|default:'' }}"
          data-login-url="{% url 'login' %}"
          data-terms-url="{% url 'terms' %}"
          data-privacy-url="{% url 'privacy' %}"
          data-google-url="{{ google_login_url }}"
          data-google-divider="Or sign up with"
        ></div>

        <div id="signup-fallback">
          <h1 class="auth-title">Create your account</h1>

          {% if user_form.errors %}
            <div class="error-box" role="alert" aria-live="polite">
              <ul>
                {% for field in user_form %}
                  {% for error in field.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                {% endfor %}
                {% for error in user_form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <form id="signup-form" method="post" action="{% url 'signup' %}" novalidate>
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.GET.next|default:'/dashboard/' }}">

            <div class="two-col">
              <div class="form-group">
                <label for="{{ user_form.first_name.id_for_label }}">First name</label>
                {{ user_form.first_name }}
                {% if user_form.first_name.errors %}<div class="field-error">{{ user_form.first_name.errors.0 }}</div>{% endif %}
              </div>

              <div class="form-group">
                <label for="{{ user_form.last_name.id_for_label }}">Last name</label>
                {{ user_form.last_name }}
                {% if user_form.last_name.errors %}<div class="field-error">{{ user_form.last_name.errors.0 }}</div>{% endif %}
              </div>
            </div>

            <div class="form-group">
              <label for="{{ user_form.username.id_for_label }}">Username</label>
              {{ user_form.username }}
              {% if user_form.username.errors %}
                <div class="field-error">{{ user_form.username.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ user_form.email.id_for_label }}">Email address</label>
              {{ user_form.email }}
              {% if user_form.email.errors %}<div class="field-error">{{ user_form.email.errors.0 }}</div>{% endif %}
            </div>

            <div class="form-group">
              <div class="label-row">
                <label for="{{ user_form.password.id_for_label }}">Password</label>
                <span class="micro-hint">At least 8 chars incl. upper, lower, number, special.</span>
              </div>

              <div class="pwd-wrap">
                {{ user_form.password }}
                <span class="pwd-toggle-text" tabindex="0"
                      role="button"
                      aria-controls="{{ user_form.password.id_for_label }}"
                      data-target="{{ user_form.password.id_for_label }}">
                  Show Password
                </span>
              </div>

              {% if user_form.password.errors %}<div class="field-error">{{ user_form.password.errors.0 }}</div>{% endif %}
              <div id="password-strength" class="field-hint" aria-live="polite"></div>
            </div>

            <div class="form-group">
              <label for="{{ user_form.confirm_password.id_for_label }}">Confirm password</label>
              {{ user_form.confirm_password }}
              {% if user_form.confirm_password.errors %}<div class="field-error">{{ user_form.confirm_password.errors.0 }}</div>{% endif %}
            </div>

            <p class="terms-text">
              By signing up you agree to our
              <a href="{% url 'terms' %}">Terms and Conditions</a> and
              <a href="{% url 'privacy' %}">Privacy Policy</a>.
            </p>

            {% if recaptcha_site_key %}
              <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
            {% endif %}
            <button type="submit" class="submit-btn">Create account</button>
          </form>

          {% include "main/partials/google_auth.html" with divider_text="Or sign up with" google_url=google_login_url %}

          <div class="secondary-actions">
            <p class="muted">Already have an account? <a href="{% url 'login' %}">Log in</a>.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/signup-react.js' %}" defer></script>
  <script src="{% static 'js/auth_clarify.js' %}" defer></script>
  {% if recaptcha_site_key %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  {% endif %}
{% endwith %}
{% endblock %}
