{% extends "base.html" %}
{% load static %}

{% block title %}ReRoute | Video Library{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'resources/css/resources.css' %}">
{% endblock %}

{% block content %}
<section class="video-library-section">
  <div class="video-library-container">
    <h1 class="page-title">Video Library</h1>
    {% if videos %}
      <div class="video-grid">
        {% for video in videos %}
          {% include 'components/video_card.html' with iframe_id='ytvid-'|add:video.id|stringformat:'s' title=video.title embed_src=video.embed_url description=video.description lesson_slug=video.lesson_slug %}
        {% endfor %}
      </div>
    {% else %}
      <p class="empty-state">No videos yet. Add some in the admin.</p>
    {% endif %}
  </div>
</section>

{% endblock %}

{% block extra_js %}
  <script>
    (function(){
      var ytIframes = document.querySelectorAll('iframe.yt-embed');
      if (!ytIframes.length) return;

      var tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      document.head.appendChild(tag);

      window.onYouTubeIframeAPIReady = function(){
        ytIframes.forEach(function(ifr){
          try {
            new YT.Player(ifr.id, {
              events: {
                onReady: function(){ /* hook for autoplay, etc. */ },
                onStateChange: function(e){
                  // Example: log end event or trigger UI updates
                  if (e.data === YT.PlayerState.ENDED) {
                    ifr.closest('.video-card')?.classList.add('video-ended');
                  }
                }
              }
            });
          } catch (err) {
            // Ignore instantiation errors for non-YouTube iframes
          }
        });
      };
    })();
  </script>
{% endblock %}
