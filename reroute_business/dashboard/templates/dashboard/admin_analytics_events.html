{% extends "dashboard/admin_base.html" %}
{% load static %}

{% block title %}Admin Analytics — Events{% endblock %}
{% block page_title %}Audit Log{% endblock %}

{% block admin_content %}
<section class="admin-section">
  <div class="admin-section-header">
    <div class="admin-section-title">Analytics — Events</div>
    <a href="{% url 'dashboard:admin' %}" class="admin-btn ghost">Back to Dashboard</a>
  </div>
  <p class="admin-subtitle">Insights for the last {{ days }} day(s).</p>
  <form method="get" class="admin-filter-row">
    <label for="days">Window:</label>
    <select name="days" id="days" class="admin-select">
      <option value="7" {% if days == 7 %}selected{% endif %}>7 days</option>
      <option value="14" {% if days == 14 %}selected{% endif %}>14 days</option>
      <option value="30" {% if days == 30 %}selected{% endif %}>30 days</option>
      <option value="90" {% if days == 90 %}selected{% endif %}>90 days</option>
    </select>
    <button type="submit" class="admin-btn primary">Apply</button>
  </form>
</section>

<section class="admin-cards">
  <div class="admin-card">
    <h3>Page Views</h3>
    <div class="stat">{{ page_views_total|default:0 }}</div>
  </div>
  <div class="admin-card">
    <h3>Unique Visitors</h3>
    <div class="stat">{{ unique_visitors|default:0 }}</div>
  </div>
  <div class="admin-card">
    <h3>Profiles Completed</h3>
    <div class="stat">{{ profiles_completed|default:0 }}</div>
  </div>
  <div class="admin-card">
    <h3>Resumes Created</h3>
    <div class="stat">{{ resumes_created|default:0 }}</div>
  </div>
</section>

<section class="admin-section">
  <div class="admin-section-header">
    <div class="admin-section-title">Trends</div>
  </div>
  <div class="analytics-grid">
    <div class="analytics-tile"><h3>Page Views by Path</h3><div id="pageViewsPie" class="plotly-chart"></div></div>
    <div class="analytics-tile"><h3>Page Views by Day</h3><div id="pageViewsLine" class="plotly-chart"></div></div>
    <div class="analytics-tile"><h3>Authed vs Anonymous Views</h3><div id="viewsStacked" class="plotly-chart"></div></div>
  </div>
</section>

<section class="admin-section">
  <div class="admin-section-header">
    <div class="admin-section-title">Top Pages</div>
  </div>
  {% if top_pages %}
  <div class="table-responsive">
    <table class="admin-table">
      <tr>
        <th>Path</th>
        <th>Views</th>
      </tr>
      {% for row in top_pages %}
      <tr>
        <td>{{ row.path|default:"/" }}</td>
        <td>{{ row.count }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% else %}
  <p class="admin-subtitle">No page views in this window.</p>
  {% endif %}
</section>

<section class="admin-section">
  <div class="admin-section-header">
    <div class="admin-section-title">Top Referrers</div>
  </div>
  {% if top_referrers %}
  <div class="table-responsive">
    <table class="admin-table">
      <tr>
        <th>Referrer</th>
        <th>Count</th>
      </tr>
      {% for row in top_referrers %}
      <tr>
        <td>{{ row.referer }}</td>
        <td>{{ row.count }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% else %}
  <p class="admin-subtitle">No referrer data available.</p>
  {% endif %}
</section>

<script id="analytics-events-data" type="application/json">
  {
    "pieLabels": {{ pie_labels|default:'[]'|safe }},
    "pieCounts": {{ pie_counts|default:'[]'|safe }},
    "lineLabels": {{ views_by_day_labels|default:'[]'|safe }},
    "lineCounts": {{ views_by_day_counts|default:'[]'|safe }},
    "authed": {{ views_by_day_authed|default:'[]'|safe }},
    "anon": {{ views_by_day_anon|default:'[]'|safe }}
  }
</script>
<script src="{% static 'dashboard/js/admin_analytics_events.js' %}"></script>
{% endblock %}
