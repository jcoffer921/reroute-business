{% extends "base.html" %}
{% load static %}
{% load profile_extras %}
{% block content %}
<link rel="stylesheet" href="{% static 'dashboard/css/notifications.css' %}">

<div class="notifications-page">
  <header class="notifications-header">
    <h1>Notifications</h1>
    <form id="markAllForm" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="mark_all_read">
      <button type="submit" class="btn-mark-read">Mark All as Read</button>
    </form>
  </header>

  <!-- Tabs -->
  <nav class="notifications-tabs">
    <button class="tab active" data-filter="all" type="button">All</button>
    <button class="tab" data-filter="jobs" type="button">Jobs</button>
    <button class="tab" data-filter="system" type="button">System</button>
    <button class="tab" data-filter="admin" type="button">Admin</button>
    <button class="tab" data-filter="tips" type="button">Tips</button>
  </nav>

  <!-- Notification List -->
  <section class="notifications-list" id="notificationsList">
    {% if notifications %}
      {% for n in notifications %}
        {# derive a simple type for styling/filtering #}
        <article
          class="notification-card {% if not n.is_read %}unread{% endif %}"
          data-type="{% if n.job or n.application or 'appl' in n.verb|default:''|lower %}jobs{% elif 'tip' in n.title|default:''|lower or 'tip' in n.message|default:''|lower %}tips{% elif n.target_group or not n.actor and not n.user %}admin{% else %}system{% endif %}"
          data-id="{{ n.id }}"
          data-markable="{% if n.user_id %}1{% else %}0{% endif %}"
          data-title="{{ n.title|default:n.verb|default:'Update' }}"
          data-message="{{ n.message|striptags }}"
          data-time="{{ n.created_at|timesince }} ago"
          {% if n.url %}data-url="{{ n.url }}"{% endif %}
        >
          <div class="avatar-wrapper">
            <div class="avatar
              {% if n.job or n.application or 'appl' in n.verb|default:''|lower %} type-jobs{% elif 'tip' in n.title|default:''|lower or 'tip' in n.message|default:''|lower %} type-tips{% elif n.target_group or not n.actor and not n.user %} type-admin{% else %} type-system{% endif %}">
              {% if n.actor and n.actor|profile_picture_url %}
                <img src="{{ n.actor|profile_picture_url }}" alt="Avatar">
              {% elif n.actor %}
                {{ n.actor|initials }}
              {% else %}
                {# Icon by type #}
                {% comment %} simple inline SVG icons {% endcomment %}
                {% if n.job or n.application or 'appl' in n.verb|default:''|lower %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M4 7h16v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Zm4-4h8a2 2 0 0 1 2 2v2H6V5a2 2 0 0 1 2-2Z"/></svg>
                {% elif n.target_group or not n.actor and not n.user %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-6h2Zm0-8h-2V7h2Z"/></svg>
                {% elif 'tip' in n.title|default:''|lower or 'tip' in n.message|default:''|lower %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M9 21h6v-1H9v1Zm7.07-4.05A7 7 0 1 0 7.93 16.95C9.1 16 10 14.6 10 13h4c0 1.6.9 3 2.07 3.95Z"/></svg>
                {% else %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V9a6 6 0 0 0-5-5.91V2h-2v1.09A6 6 0 0 0 6 9v7l-2 2v1h16v-1Z"/></svg>
                {% endif %}
              {% endif %}
            </div>
          </div>
          <div class="content">
            <div class="title">{{ n.title|default:n.verb|default:"Update" }}</div>
            <div class="message">{{ n.message }}</div>
            <div class="meta">
              {% if not n.is_read %}<span class="unread-dot" aria-label="Unread"></span>{% endif %}
              <time datetime="{{ n.created_at|date:'c' }}">{{ n.created_at|timesince }} ago</time>
            </div>
          </div>
          <div class="actions">
            {% if n.url %}
              <a href="{{ n.url }}" class="btn-action">View</a>
            {% endif %}
            {% if not n.is_read and n.user_id %}
              <form method="post" class="mark-read-form" data-id="{{ n.id }}" style="display:inline-block; margin-left:8px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="mark_read">
                <input type="hidden" name="id" value="{{ n.id }}">
                <button type="submit" class="btn-mark-one" title="Mark as read" aria-label="Mark as read">âœ“</button>
              </form>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty">No notifications yet.</p>
    {% endif %}
  </section>

  <!-- Dynamic empty state for filters -->
  <div id="notificationsEmptyState" class="empty" style="display:none;">
    <div class="empty-illustration" aria-hidden="true">ðŸ””</div>
    <div class="empty-text">You're all caught up.</div>
  </div>

  <!-- Drawer for notification details -->
  <div id="notifDrawerOverlay" class="notif-drawer-overlay" role="presentation"></div>
  <aside id="notifDrawer" class="notif-drawer" aria-hidden="true" aria-label="Notification details">
    <header>
      <h2 id="notifDrawerTitle" style="margin:0; font-size:1rem;">Notification</h2>
      <button id="notifDrawerClose" class="btn-secondary" type="button">Close</button>
    </header>
    <div class="content">
      <p id="notifDrawerMessage" style="margin-top:8px;"></p>
      <p id="notifDrawerTime" style="color:#6b7280; font-size:0.85rem;"></p>
    </div>
    <div class="actions">
      <a id="notifDrawerLink" class="btn-action" href="#" target="_self" style="display:none;">Open Link</a>
      <button id="notifDrawerClose2" class="btn-secondary" type="button">Done</button>
    </div>
  </aside>
</div>

<script src="{% static 'dashboard/js/notifications.js' %}"></script>
{% endblock %}
