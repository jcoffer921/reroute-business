{% extends "base.html" %}
{% load static %}
{% load profile_extras %}
{% block content %}
<link rel="stylesheet" href="{% static 'dashboard/css/notifications.css' %}">

<div class="notifications-page">
  <header class="notifications-header">
    <div class="header-left">
      <div class="bell-badge" aria-hidden="true">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V9a6 6 0 0 0-5-5.91V2h-2v1.09A6 6 0 0 0 6 9v7l-2 2v1h16v-1Z"/></svg>
      </div>
      <div>
        <h1>Notifications</h1>
        <p class="notifications-subhead">{{ unread_count|default:0 }} unread</p>
      </div>
    </div>
    <form id="markAllForm" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="mark_all_read">
      <button type="submit" class="btn-mark-read">Mark all read</button>
    </form>
  </header>

  <div class="notifications-toolbar">
    <nav class="notifications-tabs">
      <button class="tab active" data-filter="all" type="button">All</button>
      <button class="tab" data-filter="jobs" type="button">Jobs</button>
      <button class="tab" data-filter="applications" type="button">Applications</button>
      <button class="tab" data-filter="invites" type="button">Invites</button>
      <button class="tab" data-filter="platform" type="button">Platform</button>
    </nav>
    <label class="unread-toggle">
      <input type="checkbox" id="unreadOnlyToggle">
      <span>Unread only</span>
    </label>
  </div>

  <!-- Notification List -->
  <section class="notifications-list" id="notificationsList">
    {% if notifications %}
      {% for n in notifications %}
        {# derive a simple type for styling/filtering #}
        <article
          class="notification-card {% if not n.is_read %}unread{% endif %}"
          data-type="{% if n.application or 'application' in n.title|default:''|lower or 'application' in n.message|default:''|lower or 'appl' in n.verb|default:''|lower %}applications{% elif 'invite' in n.title|default:''|lower or 'invite' in n.message|default:''|lower or 'invite' in n.verb|default:''|lower %}invites{% elif n.job %}jobs{% else %}platform{% endif %}"
          data-id="{{ n.id }}"
          data-markable="{% if n.user_id %}1{% else %}0{% endif %}"
          data-title="{{ n.title|default:n.verb|default:'Update' }}"
          data-message="{{ n.message|striptags }}"
          data-time="{{ n.created_at|timesince }} ago"
          {% if n.url %}data-url="{{ n.url }}"{% endif %}
        >
          <div class="avatar-wrapper">
            <div class="avatar
              {% if n.application or 'application' in n.title|default:''|lower or 'application' in n.message|default:''|lower or 'appl' in n.verb|default:''|lower %} type-applications{% elif 'invite' in n.title|default:''|lower or 'invite' in n.message|default:''|lower or 'invite' in n.verb|default:''|lower %} type-invites{% elif n.job %} type-jobs{% else %} type-platform{% endif %}">
              {% if n.actor and n.actor|profile_picture_url %}
                <img src="{{ n.actor|profile_picture_url }}" alt="Avatar">
              {% elif n.actor %}
                {{ n.actor|initials }}
              {% else %}
                {# Icon by type #}
                {% comment %} simple inline SVG icons {% endcomment %}
                {% if n.application or 'application' in n.title|default:''|lower or 'application' in n.message|default:''|lower or 'appl' in n.verb|default:''|lower %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M4 7h16v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Zm4-4h8a2 2 0 0 1 2 2v2H6V5a2 2 0 0 1 2-2Z"/></svg>
                {% elif 'invite' in n.title|default:''|lower or 'invite' in n.message|default:''|lower or 'invite' in n.verb|default:''|lower %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M12 2a5 5 0 0 1 5 5v1h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10a2 2 0 0 1 2-2h2V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v1h6V7a3 3 0 0 0-3-3Z"/></svg>
                {% elif n.job %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M4 7h16v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Zm4-4h8a2 2 0 0 1 2 2v2H6V5a2 2 0 0 1 2-2Z"/></svg>
                {% else %}
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-6h2Zm0-8h-2V7h2Z"/></svg>
                {% endif %}
              {% endif %}
            </div>
          </div>
          <div class="content">
            <div class="title">{{ n.title|default:n.verb|default:"Update" }}</div>
            <div class="message">{{ n.message }}</div>
            <div class="meta">
              <time datetime="{{ n.created_at|date:'c' }}">{{ n.created_at|timesince }} ago</time>
            </div>
          </div>
          <div class="actions">
            {% if n.url %}
              <a href="{{ n.url }}" class="btn-action" data-cta>View</a>
            {% else %}
              <button type="button" class="btn-action btn-disabled" disabled>View</button>
            {% endif %}
            {% if not n.is_read and n.user_id %}
              <form method="post" class="mark-read-form inline-form" data-id="{{ n.id }}">
                {% csrf_token %}
                <input type="hidden" name="action" value="mark_read">
                <input type="hidden" name="id" value="{{ n.id }}">
                <button type="submit" class="btn-mark-one" title="Mark as read" aria-label="Mark as read">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 12l4 4 8-8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </form>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty">No notifications yet.</p>
    {% endif %}
  </section>

  <!-- Dynamic empty state for filters -->
  <div id="notificationsEmptyState" class="empty empty-box" hidden>
    <div class="empty-illustration" aria-hidden="true">ðŸ””</div>
    <div class="empty-text">You're all caught up.</div>
  </div>

</div>

<script src="{% static 'dashboard/js/notifications.js' %}"></script>
{% endblock %}
