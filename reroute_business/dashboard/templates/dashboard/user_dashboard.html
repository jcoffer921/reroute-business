{% extends "base.html" %}
{% load static %}

{% block title %}User Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/base.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/css/user_dashboard.css' %}">
{% endblock %}

{% block content %}
{% load profile_extras %}
<section class="dashboard-hero">
  <div class="dashboard-hero-inner">
    <header class="dash-hero">
      <div class="dash-hero-content">
        <p class="eyebrow">Dashboard</p>
        <h1>Welcome, {{ request.user.first_name|default:request.user.username }}!</h1>
        <p class="muted">Keep momentum with your profile and resume while employers onboard.</p>
        {% if early_access_mode %}
          <div class="early-access-banner">{{ early_access_message }}</div>
        {% endif %}
        {% if profile.early_access_priority %}
          <span class="pill">Early Access — Priority Profile</span>
        {% endif %}
        <div class="hero-stats">
          <div class="hero-stat">
            <p class="stat-label">Matches{% if not jobs_live %} (soon){% endif %}</p>
            <p class="stat-number">{{ stats.matches_found|default:0 }}</p>
          </div>
          <div class="hero-stat">
            <p class="stat-label">Applications</p>
            <p class="stat-number">{{ stats.applications_sent|default:0 }}</p>
          </div>
          <div class="hero-stat">
            <p class="stat-label">Profile views</p>
            <p class="stat-number">{{ stats.profile_views|default:0 }}</p>
          </div>
        </div>
      </div>
    </header>
  </div>
</section>

<div class="dashboard-shell">
  <aside class="dash-sidebar">
    {% with active=request.resolver_match.url_name %}
    <div class="sidebar-section">
      <p class="sidebar-label">Main</p>
      <a class="sidebar-link {% if active == 'user' %}active{% endif %}" href="{% url 'dashboard:user' %}">Dashboard</a>
      <a class="sidebar-link" href="{% url 'dashboard:notifications' %}">Notifications</a>
    </div>
    <div class="sidebar-section">
      <p class="sidebar-label">Career</p>
      <a class="sidebar-link" href="{% url 'opportunities' %}">Jobs</a>
      <a class="sidebar-link" href="{% url 'dashboard:saved_jobs' %}">Saved Jobs</a>
    </div>
    <div class="sidebar-section">
      <p class="sidebar-label">Learning</p>
      <a class="sidebar-link" href="{% url 'resource_list' %}#modules">Modules</a>
      <a class="sidebar-link" href="{% url 'reentry_org:organization_catalog' %}">Reentry Orgs</a>
    </div>
    <div class="sidebar-section">
      <p class="sidebar-label">Account</p>
      <a class="sidebar-link" href="{% url 'settings' %}?panel=profile">Profile Settings</a>
      <a class="sidebar-link" href="{% url 'contact' %}">Support</a>
    </div>
    {% endwith %}
  </aside>

  <main class="dash-main">

    <section class="card next-step-card" aria-label="Next step">
      <div class="next-step-content">
        <p class="eyebrow">Next step</p>
        <h2>{{ next_step.title }}</h2>
        <p class="muted">{{ next_step.desc }}</p>
      </div>
      <a class="btn btn-primary" href="{{ next_step.url }}">{{ next_step.cta }}</a>
    </section>

    <div class="grid two-col">
      <section class="card interviews-card">
        <div class="section-heading">
          <div>
            <h2>Scheduled Interviews</h2>
            <p>Upcoming interviews you have lined up</p>
          </div>
          <button type="button" id="openUserInterviews" class="btn btn-primary btn-sm">View</button>
        </div>
        {% if upcoming_interviews %}
          <div class="list-stack">
            {% for iv in upcoming_interviews %}
              <article class="stack-item">
                <div class="stack-body">
                  <div class="stack-title">
                    <a href="{% url 'job_detail' iv.job.id %}">{{ iv.job.title }}</a>
                    <span class="muted"> · {{ iv.employer.get_full_name|default:iv.employer.username }}</span>
                  </div>
                  <div class="stack-meta">
                    <span class="badge subtle">Interview</span>
                    <time datetime="{{ iv.scheduled_at|date:'c' }}">{{ iv.scheduled_at|date:"M d, Y g:ia" }}</time>
                  </div>
                </div>
              </article>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state minimal">
            <h4>No interviews scheduled</h4>
            <p>{% if jobs_live %}Keep applying and we’ll place interviews here.{% else %}We’ll place interviews here once jobs launch.{% endif %}</p>
          </div>
        {% endif %}
      </section>

      <section class="card tips-card">
        <div class="section-heading">
          <div>
            <h2>Helpful Tips</h2>
            <p>Personalized nudges and next steps</p>
          </div>
          <button id="nextTipBtn" class="btn btn-outline btn-sm">Next</button>
        </div>
        <div id="tipText" class="tip-item">Loading tips...</div>
      </section>
    </div>

    <section class="card progress-card">
      <div class="section-heading">
        <div>
          <h2>Your Progress</h2>
          <p>Track readiness across resume, profile, and learning</p>
        </div>
        <a href="{{ PROFILE_URL }}" class="link-sm">View details</a>
      </div>
      <div class="progress-grid">
        {% with resume_percent=resume|yesno:"92,40" %}
        <div class="progress-tile" data-value="{{ resume_percent }}">
          <div class="progress-ring" aria-hidden="true"></div>
          <div class="progress-meta">
            <p class="label">Resume completeness</p>
            <p class="value">{{ resume_percent }}%</p>
            <p class="hint">
              {% if resume %}
                Great work—keep it updated.
              {% else %}
                {% if jobs_live %}Upload to unlock matches.{% else %}Upload to unlock early access.{% endif %}
              {% endif %}
            </p>
          </div>
        </div>
        {% endwith %}
        <div class="progress-tile" data-value="{{ modules_completed_percent|default:0 }}">
          <div class="progress-ring" aria-hidden="true"></div>
          <div class="progress-meta">
            <p class="label">Modules completed</p>
            <p class="value">{{ modules_completed|default:0 }}</p>
            <p class="hint"><a href="{% url 'resource_list' %}#modules">Continue learning</a></p>
          </div>
        </div>
        <div class="progress-tile" data-value="{{ completion_percentage|default:0 }}">
          <div class="progress-ring" aria-hidden="true"></div>
          <div class="progress-meta">
            <p class="label">Profile completion</p>
            <p class="value">{{ completion_percentage|default:0 }}%</p>
            <p class="hint">Finish your profile for better matches.</p>
          </div>
        </div>
        <div class="progress-tile" data-value="{{ organizations_saved_count|default:0 }}">
          <div class="progress-ring" aria-hidden="true"></div>
          <div class="progress-meta">
            <p class="label">Organizations saved</p>
            <p class="value">{{ organizations_saved_count|default:0 }}</p>
            <p class="hint"><a href="{% url 'reentry_org:organization_catalog' %}">Browse support near you</a></p>
          </div>
        </div>
      </div>
    </section>

    <section class="card recs-card" data-tab-group="recs">
      <div class="section-heading">
        <div>
          <h2>Recommendations</h2>
          <p>{% if jobs_live %}Jobs, organizations, and modules tailored for you{% else %}Organizations and modules tailored for you. Jobs launch soon.{% endif %}</p>
        </div>
        <div class="tabs">
          <button class="tab-btn active" data-tab="jobs">{% if jobs_live %}Jobs for You{% else %}Jobs (Launching Soon){% endif %}</button>
          <button class="tab-btn" data-tab="orgs">Reentry Organizations</button>
          <button class="tab-btn" data-tab="modules">Recommended Modules</button>
        </div>
      </div>

      <div class="tab-panels">
        <div class="tab-panel active" data-tab-panel="jobs">
          {% if not jobs_live %}
            <div class="empty-state minimal">
              <h4>Jobs are launching soon</h4>
              <p>{{ early_access_message }}</p>
            </div>
          {% elif suggested_cards %}
            <div class="card-grid three-col">
              {% for item in suggested_cards|slice:":6" %}
                {% with job=item.job %}
                <article class="recommend-card">
                  <div class="recommend-top">
                    <div>
                      <p class="badge subtle">{{ job.location|default:"Location flexible" }}</p>
                      <h3 class="recommend-title">{{ job.title }}</h3>
                      <p class="muted">{{ job.employer.username }}</p>
                    </div>
                    {% if item.match %}
                      <span class="pill pill-ghost">{{ item.match }}% match</span>
                    {% endif %}
                  </div>
                  <div class="recommend-actions">
                    <a class="btn btn-primary btn-sm" href="{% url 'job_detail' job.id %}">Apply</a>
                    <form method="post" action="{% url 'toggle_saved_job' %}">
                      {% csrf_token %}
                      <input type="hidden" name="job_id" value="{{ job.id }}">
                      <button type="submit" class="btn btn-outline btn-sm">Save</button>
                    </form>
                  </div>
                </article>
                {% endwith %}
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state minimal">
              <h4>No job recommendations yet</h4>
              <p>Tell us more about your skills to improve matches.</p>
              <a class="btn btn-outline btn-sm" href="{{ PROFILE_URL }}">Update preferences</a>
            </div>
          {% endif %}
        </div>

        <div class="tab-panel" data-tab-panel="orgs">
          {% if recommended_orgs %}
            <div class="card-grid three-col">
              {% for org in recommended_orgs %}
                <article class="recommend-card">
                  <div class="recommend-top">
                    <div>
                      <p class="badge subtle">{{ org.get_category_display|default:"Support" }}</p>
                      <h3 class="recommend-title">{{ org.name }}</h3>
                      <p class="muted">{% if org.city or org.state %}{{ org.city }}{% if org.city and org.state %}, {% endif %}{{ org.state }}{% else %}Location TBD{% endif %}</p>
                    </div>
                    <span class="pill pill-ghost">Support</span>
                  </div>
                  <p class="muted">{{ org.description|default:"Verified organization ready to help."|truncatechars:120 }}</p>
                  <div class="recommend-actions">
                    <form method="post" action="{% url 'reentry_org:toggle_saved_org' %}">
                      {% csrf_token %}
                      <input type="hidden" name="organization_id" value="{{ org.id }}">
                      <input type="hidden" name="next" value="{{ request.path }}">
                      {% if org.id in saved_org_ids %}
                        <button class="btn btn-outline btn-sm" type="submit">Unsave</button>
                      {% else %}
                        <button class="btn btn-primary btn-sm" type="submit">Save</button>
                      {% endif %}
                    </form>
                    <a class="btn btn-primary btn-sm" href="{% url 'reentry_org:organization_catalog' %}?q={{ org.name|urlencode }}">View</a>
                    <a class="btn btn-outline btn-sm" href="{{ org.website|default:'#' }}" target="_blank" rel="noopener">Open site</a>
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state minimal">
              <h4>No organizations to show</h4>
              <p>Browse the catalog to find housing, legal, and training support.</p>
              <a class="btn btn-outline btn-sm" href="{% url 'reentry_org:organization_catalog' %}">Browse organizations</a>
            </div>
          {% endif %}
        </div>

        <div class="tab-panel" data-tab-panel="modules">
          {% if recommended_modules %}
            <div class="card-grid three-col">
              {% for mod in recommended_modules %}
                <article class="recommend-card">
                  <div class="recommend-top">
                    <div>
                      <p class="badge subtle">{{ mod.get_category_display|default:"Module" }}</p>
                      <h3 class="recommend-title">{{ mod.title }}</h3>
                    </div>
                    <span class="pill pill-ghost">Learning</span>
                  </div>
                  <p class="muted">{{ mod.description|default:"Keep building your skills with this module."|truncatechars:120 }}</p>
                  <div class="recommend-actions">
                    <a class="btn btn-primary btn-sm" href="{% url 'module_detail' mod.id %}">Start</a>
                    <a class="btn btn-outline btn-sm" href="{% url 'resource_list' %}#modules">More modules</a>
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state minimal">
              <h4>No module recommendations yet</h4>
              <p>Pick a track to start learning and we’ll recommend next steps.</p>
              <a class="btn btn-outline btn-sm" href="{% url 'resource_list' %}#modules">Browse modules</a>
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- User Interviews Modal -->
    <div id="userInterviewsBackdrop" class="modal-backdrop hidden"></div>
    <div id="userInterviewsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="userInterviewsTitle">
      <div class="modal-content" id="userInterviewsContent">
        <!-- Fetched dynamically -->
      </div>
    </div>
  </main>
</div>

<script src="{% static 'dashboard/js/user_dashboard.js' %}"></script>
{% endblock %}
