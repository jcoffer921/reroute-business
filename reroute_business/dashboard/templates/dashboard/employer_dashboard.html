{% extends "dashboard/employer_base.html" %}
{% load static %}

{% block title %}Employer Dashboard{% endblock %}
{% block body_class %}employer-dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
{{ block.super }}
{% endblock %}

{% block employer_content %}
<section class="dashboard-hero">
  <div class="hero-copy">
    <h1>Welcome back</h1>
    <p class="muted">Here is an overview of your hiring activity.</p>
  </div>
  {% if not employer_verified %}
    <div class="status-banner" role="status">
      <strong>Pending verification:</strong> Complete your company profile to unlock job posting.
    </div>
  {% endif %}
</section>

<section class="summary-grid">
  <article class="summary-card">
    <span class="summary-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="4" y="5" width="16" height="14" rx="2" />
        <path d="M8 5V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1" />
      </svg>
    </span>
    <span class="summary-value">{{ active_jobs|default:0 }}</span>
    <span class="summary-label">Active Postings</span>
  </article>
  <article class="summary-card">
    <span class="summary-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <circle cx="12" cy="8" r="4" />
        <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
      </svg>
    </span>
    <span class="summary-value">{{ total_applications|default:0 }}</span>
    <span class="summary-label">Total Applicants</span>
  </article>
  <article class="summary-card">
    <span class="summary-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z" />
        <circle cx="12" cy="12" r="3" />
      </svg>
    </span>
    <span class="summary-value">{{ pipeline_counts.under_review|default:0 }}</span>
    <span class="summary-label">Under Review</span>
    {% if pipeline_counts.under_review|default:0|add:0 > 0 %}
      <span class="summary-alert">Needs your attention</span>
    {% endif %}
  </article>
  <article class="summary-card">
    <span class="summary-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="4" y="5" width="16" height="16" rx="2" />
        <path d="M8 3v4M16 3v4M4 11h16" />
      </svg>
    </span>
    <span class="summary-value">{{ interviews|length }}</span>
    <span class="summary-label">Interviews</span>
  </article>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Hiring Pipeline</h2>
      <p class="muted">Track candidates through your hiring process.</p>
    </div>
    <a class="text-link" href="#recent-applicants">View all applicants &rarr;</a>
  </div>
  <div class="pipeline-grid">
    <article class="pipeline-card">
      <div class="pipeline-dot"></div>
      <div>
        <p class="pipeline-label">New</p>
        <p class="pipeline-value">{{ pipeline_counts.new|default:0 }}</p>
        <p class="pipeline-meta">candidates</p>
      </div>
    </article>
    <article class="pipeline-card">
      <div class="pipeline-dot"></div>
      <div>
        <p class="pipeline-label">Under Review</p>
        <p class="pipeline-value">{{ pipeline_counts.under_review|default:0 }}</p>
        <p class="pipeline-meta">candidates</p>
      </div>
    </article>
    <article class="pipeline-card">
      <div class="pipeline-dot"></div>
      <div>
        <p class="pipeline-label">Interview</p>
        <p class="pipeline-value">{{ pipeline_counts.interview|default:0 }}</p>
        <p class="pipeline-meta">candidates</p>
      </div>
    </article>
    <article class="pipeline-card">
      <div class="pipeline-dot"></div>
      <div>
        <p class="pipeline-label">Decision</p>
        <p class="pipeline-value">{{ pipeline_counts.decision|default:0 }}</p>
        <p class="pipeline-meta">candidate</p>
      </div>
    </article>
  </div>
</section>

<section class="dashboard-grid">
  <div class="panel" id="recent-applicants">
    <div class="panel-header">
      <h2>Recent Applicants</h2>
      <a class="text-link" href="{% url 'dashboard:employer' %}#applicants">View all</a>
    </div>
    <div class="applicant-list">
      {% for app in recent_applications %}
        <div class="applicant-row">
          <div class="avatar-circle">{{ app.applicant.first_name|default:app.applicant.username|slice:":1" }}</div>
          <div class="applicant-info">
            <p class="applicant-name">{{ app.applicant.first_name|default:app.applicant.username }}</p>
            <p class="muted">{{ app.job.location|default:"Remote" }} &middot; {{ app.job.title }}</p>
          </div>
          <span class="stage-pill">
            {% if app.status == 'pending' %}New{% elif app.status == 'reviewed' %}Under Review{% elif app.status == 'interview' %}Interview{% else %}Decision{% endif %}
          </span>
        </div>
      {% empty %}
        <div class="empty-state">
          <p>No applicants yet.</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <aside class="side-panel">
    <div class="panel tip-card">
      <div class="tip-header">
        <span class="summary-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M4 4h14a2 2 0 0 1 2 2v12" />
            <path d="M4 6v14a2 2 0 0 0 2 2h14" />
          </svg>
        </span>
        <h3>Fair-Chance Tip</h3>
      </div>
      <p class="muted">Fair-chance employers report higher retention rates and workplace loyalty.</p>
      <a class="text-link" href="{% url 'resource_list' %}">View full guide &rarr;</a>
    </div>

    <div class="panel quick-actions">
      <h3>Quick Actions</h3>
      <a class="action-row" href="{% url 'create_job' %}">
        <span class="summary-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <rect x="4" y="5" width="16" height="14" rx="2" />
            <path d="M8 5V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1" />
          </svg>
        </span>
        Post a new job
      </a>
      <a class="action-row" href="{% url 'dashboard:employer_company_profile' %}">
        <span class="summary-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="12" cy="8" r="4" />
            <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
          </svg>
        </span>
        Update company profile
      </a>
    </div>
  </aside>
</section>

<!-- ====== Schedule Interview Modal ====== -->
<div id="scheduleInterviewBackdrop" class="modal-backdrop hidden"></div>
<div id="scheduleInterviewModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="scheduleInterviewTitle">
  <div class="modal-content">
    <button class="modal-close" id="scheduleInterviewClose" aria-label="Close">x</button>
    <h3 id="scheduleInterviewTitle" style="margin-top:0;">Schedule Interview</h3>
    <form method="post" action="{% url 'dashboard:schedule_interview' %}" class="edit-form" style="padding:0;">
      {% csrf_token %}
      <p>
        <label for="jobSelect">Job</label>
        <select required id="jobSelect" name="job_id">
          {% for j in jobs %}
            <option value="{{ j.id }}">{{ j.title }}</option>
          {% endfor %}
        </select>
      </p>
      <p>
        <label for="cand">Candidate Username</label>
        <input type="text" id="cand" name="candidate_username" required placeholder="e.g. janedoe" />
      </p>
      <p>
        <label for="dt">Date &amp; Time</label>
        <input type="datetime-local" id="dt" name="datetime" required />
      </p>
      <p>
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Notes for the interview..."></textarea>
      </p>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Schedule</button>
        <button type="button" class="btn btn-secondary" id="scheduleInterviewClose2">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- ====== Reschedule Interview Modal ====== -->
<div id="rescheduleInterviewBackdrop" class="modal-backdrop hidden"></div>
<div id="rescheduleInterviewModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="rescheduleInterviewTitle">
  <div class="modal-content">
    <button class="modal-close" id="rescheduleInterviewClose" aria-label="Close">x</button>
    <h3 id="rescheduleInterviewTitle" style="margin-top:0;">Reschedule Interview</h3>
    <form method="post" action="{% url 'dashboard:reschedule_interview' %}" class="edit-form" style="padding:0;">
      {% csrf_token %}
      <input type="hidden" id="rescheduleInterviewId" name="interview_id" value="">
      <p>
        <label for="rescheduleDt">New Date &amp; Time</label>
        <input type="datetime-local" id="rescheduleDt" name="datetime" required />
      </p>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" id="rescheduleInterviewClose2">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- ====== Modal for applicants ====== -->
<div id="modalBackdrop" class="modal-backdrop hidden"></div>
<div id="modalRoot" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <button class="modal-close" aria-label="Close">x</button>
    <div id="modalBody">Loading...</div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'dashboard/js/employer_dashboard.js' %}" defer></script>
  <script src="{% static 'dashboard/js/employer_dashboard_modals.js' %}" defer></script>
{% endblock %}
